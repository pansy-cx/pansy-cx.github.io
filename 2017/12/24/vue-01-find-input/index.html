<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Virigl,mrchan3668@gmail.com"><title>从 Vue 源码学前端（01） —— 找到入口文件 · Virgil Chan</title><meta name="description" content="引言距之前看 underscore 源码之后，我又开了个坑，这次看 Vue 源码。  
看源码之前，首先要先明确一点，看源码的目的是什么，之前看 underscore 是为了「理解」 JavaScript，学习 JS 的特性、用法，去理解它，发现 JS 不一样的世界。妈蛋真是越说越玄。总之，之前看源"><meta name="keywords" content="HTML,CSS,JavaScript,Vue,AngularJS,WebPack,UnderScore,System,Raspberry,Tool,Linux,WordPress,NodeJS,MongoDB,Git,Python"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="manifest" href="/manifest.json"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/favicon.png" style="width:127px;"><h3 title><a href="/">Virgil Chan</a></h3><div class="description"><p>间歇性凌云壮志，持续性混吃等死</p></div></div></div><ul class="social-links"><li><a href="http://www.feed43.com/6708067855351261.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/1953548815"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/pansy-cx"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>从 Vue 源码学前端（01） —— 找到入口文件</a></h3></div><div class="post-content"><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>距之前看 underscore 源码之后，我又开了个坑，这次看 Vue 源码。  </p>
<p>看源码之前，首先要先明确一点，看源码的目的是什么，之前看 underscore 是为了「理解」 JavaScript，学习 JS 的特性、用法，去理解它，发现 JS 不一样的世界。妈蛋真是越说越玄。总之，之前看源码是为了从入门到掌握而打的基本功。</p>
<p>而学习 Vue 呢，一开始是出于好奇，从来没见过 JS 还可以这么用，这么简便，自然就想去知道是怎么实现的。以前也看过一部分源码，比如前端路由的实现，双向绑定之类的，但仍然不过瘾。现在正好有时间，打算从头到尾看一遍，了解大神们是怎么构建工程，优化代码，造轮子的思想，神奇的功能等等等等。</p>
<p>话不多说，万事开头难，先把东西下下来再说，从 GitHub 上 clone 项目下来，现在是 2.5.11 版本，先看看构造，哇一大堆，还好之前用过 vue-cli，入门了点 WebPack 知识，不至于看不懂。先把重点挑出来：</p>
<ul>
<li>build：WebPack 及其他一些自动化工具的配置</li>
<li>dist：工程输出文件</li>
<li>example：例子，应该会很用用</li>
<li>src：项目代码全在这里吗</li>
<li>test：测试用的</li>
<li>package.json：这就不用说了</li>
</ul>
<h3 id="输出文件"><a href="#输出文件" class="headerlink" title="输出文件"></a>输出文件</h3><p>先来瞟一眼 dist 里面的文件，除了 vue.js 和 vue.min.js 以外居然还有其他一堆文件，还好作者贴心的提供了 <a href="https://github.com/vuejs/vue/blob/dev/dist/README.md" target="_blank">README.md</a>。</p>
<p><img src="http://p8hsqsg3r.bkt.clouddn.com/dist.readme.png" alt></p>
<p>很明白，production 是两个 min 文件，用于项目正式使用。</p>
<p>根据功能还分为 Full、Compiler、Runtime：</p>
<ul>
<li>Full：包括 Compile 和 Runtime 两部分功能</li>
<li>Compile：compiling template strings into JavaScript render functions（我发现我能看到不会翻译）就是将 template 解析成 js 代码。</li>
<li>Runtime：除了 Compile 的其他功能，比如 Virtual DOM 等。</li>
</ul>
<p>根据使用方式分为 UMD、CommonJS、ES Module：</p>
<ul>
<li>UMD：JS 正常的加载方式，源码是长这样，很熟悉。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">global, factory</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">typeof</span> exports === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span> !== <span class="string">'undefined'</span> ? <span class="built_in">module</span>.exports = factory() :</span><br><span class="line">    <span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd ? define(factory) :</span><br><span class="line">    (global.Vue = factory());</span><br><span class="line">&#125;(<span class="keyword">this</span>, (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="string">'use strict'</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;)));</span><br></pre></td></tr></table></figure>
<ul>
<li>CommonJS：Node 的加载方式，就是你用 require() 方法调用加载的是这个文件。最后一行： module.exports = Vue$3;</li>
<li>ES Module：ES6 的加载方式，import 方式调用的是这个文件。和 CommonJS 源码一样，只有最后一行不同：export default Vue$3;</li>
</ul>
<p>module.exports 和 export 有什么区别？</p>
<p>我们知道 Node 是根据 CommonJS 引用规范的，每个文件就是一个模块，有着自己的作用域，module 代表的就是模块本身，其中 exports 属性是对外的接口，加载某个模块，就是加载 module.exports。而 Node 还给每个模块提供了一个 exports 变量：var exports = module.exports。所以 exports 或 module.exports 指向了新的对象，exports 和 module.exports 就切断了联系。</p>
<p>ES6 则是用 export 和 import 来导出导入模块，export 不同的是可以按需加载。</p>
<h3 id="查找入口文件"><a href="#查找入口文件" class="headerlink" title="查找入口文件"></a>查找入口文件</h3><p>看一下 package.json 的 script。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">"dev": "rollup -w -c build/config.js --environment TARGET:web-full-dev",</span><br><span class="line">"dev:cjs": "rollup -w -c build/config.js --environment TARGET:web-runtime-cjs",</span><br><span class="line">"dev:esm": "rollup -w -c build/config.js --environment TARGET:web-runtime-esm",</span><br><span class="line">"dev:test": "karma start test/unit/karma.dev.config.js",</span><br><span class="line">"dev:ssr": "rollup -w -c build/config.js --environment TARGET:web-server-renderer",</span><br><span class="line">"dev:compiler": "rollup -w -c build/config.js --environment TARGET:web-compiler ",</span><br><span class="line">"dev:weex": "rollup -w -c build/config.js --environment TARGET:weex-framework",</span><br><span class="line">"dev:weex:factory": "rollup -w -c build/config.js --environment TARGET:weex-factory",</span><br><span class="line">"dev:weex:compiler": "rollup -w -c build/config.js --environment TARGET:weex-compiler "</span><br></pre></td></tr></table></figure>
<p>Rollup 是一个 JavaScript 模块打包器，不同的 dist 输出就是根据 Rollup 来控制的，可以看到引用的文件是 build/config.js，在看看 build/config.js。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> builds = &#123;</span><br><span class="line">  <span class="comment">// Runtime only (CommonJS). Used by bundlers e.g. Webpack &amp; Browserify</span></span><br><span class="line">  <span class="string">'web-runtime-cjs'</span>: &#123;</span><br><span class="line">    entry: resolve(<span class="string">'web/entry-runtime.js'</span>),</span><br><span class="line">    dest: resolve(<span class="string">'dist/vue.runtime.common.js'</span>),</span><br><span class="line">    format: <span class="string">'cjs'</span>,</span><br><span class="line">    banner</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// Runtime+compiler CommonJS build (CommonJS)</span></span><br><span class="line">  <span class="string">'web-full-cjs'</span>: &#123;</span><br><span class="line">    entry: resolve(<span class="string">'web/entry-runtime-with-compiler.js'</span>),</span><br><span class="line">    dest: resolve(<span class="string">'dist/vue.common.js'</span>),</span><br><span class="line">    format: <span class="string">'cjs'</span>,</span><br><span class="line">    alias: &#123; <span class="attr">he</span>: <span class="string">'./entity-decoder'</span> &#125;,</span><br><span class="line">    banner</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>resolve 是一个查找文件的函数，不重要，entry-runtime.js 和 entry-runtime-with-compiler 分别是 Runtime 和 Full 版，看一下这两个文件。</p>
<p>entry-runtime.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'./runtime/index'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>
<p>entry-runtime-with-compiler.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'core/config'</span></span><br><span class="line"><span class="keyword">import</span> &#123; warn, cached &#125; <span class="keyword">from</span> <span class="string">'core/util/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mark, measure &#125; <span class="keyword">from</span> <span class="string">'core/util/perf'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'./runtime/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; query &#125; <span class="keyword">from</span> <span class="string">'./util/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; compileToFunctions &#125; <span class="keyword">from</span> <span class="string">'./compiler/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; shouldDecodeNewlines, shouldDecodeNewlinesForHref &#125; <span class="keyword">from</span> <span class="string">'./util/compat'</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>
<p>这些多出来的，就是 template 解析器的函数了，现在重点不是 template，可以看到两个文件都引用了 ./runtime/index，跟着代码查过去。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'core/index'</span></span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'core/config'</span></span><br><span class="line"><span class="keyword">import</span> &#123; extend, noop &#125; <span class="keyword">from</span> <span class="string">'shared/util'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mountComponent &#125; <span class="keyword">from</span> <span class="string">'core/instance/lifecycle'</span></span><br><span class="line"><span class="keyword">import</span> &#123; devtools, inBrowser, isChrome &#125; <span class="keyword">from</span> <span class="string">'core/util/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  query,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  isReservedAttr,</span><br><span class="line">  getTagNamespace,</span><br><span class="line">  isUnknownElement</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'web/util/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; patch &#125; <span class="keyword">from</span> <span class="string">'./patch'</span></span><br><span class="line"><span class="keyword">import</span> platformDirectives <span class="keyword">from</span> <span class="string">'./directives/index'</span></span><br><span class="line"><span class="keyword">import</span> platformComponents <span class="keyword">from</span> <span class="string">'./components/index'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// install platform specific utils</span></span><br><span class="line">Vue.config.mustUseProp = mustUseProp</span><br><span class="line">Vue.config.isReservedTag = isReservedTag</span><br><span class="line">Vue.config.isReservedAttr = isReservedAttr</span><br><span class="line">Vue.config.getTagNamespace = getTagNamespace</span><br><span class="line">Vue.config.isUnknownElement = isUnknownElement</span><br><span class="line"></span><br><span class="line"><span class="comment">// install platform runtime directives &amp; components</span></span><br><span class="line">extend(Vue.options.directives, platformDirectives)</span><br><span class="line">extend(Vue.options.components, platformComponents)</span><br><span class="line"></span><br><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> mountComponent(<span class="keyword">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// devtools global hook</span></span><br><span class="line"><span class="comment">/* istanbul ignore next */</span></span><br><span class="line">Vue.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (config.devtools) &#123;</span><br><span class="line">    <span class="keyword">if</span> (devtools) &#123;</span><br><span class="line">      devtools.emit(<span class="string">'init'</span>, Vue)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; isChrome) &#123;</span><br><span class="line">      <span class="built_in">console</span>[<span class="built_in">console</span>.info ? <span class="string">'info'</span> : <span class="string">'log'</span>](</span><br><span class="line">        <span class="string">'Download the Vue Devtools extension for a better development experience:\n'</span> +</span><br><span class="line">        <span class="string">'https://github.com/vuejs/vue-devtools'</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    config.productionTip !== <span class="literal">false</span> &amp;&amp;</span><br><span class="line">    inBrowser &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">console</span> !== <span class="string">'undefined'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="built_in">console</span>[<span class="built_in">console</span>.info ? <span class="string">'info'</span> : <span class="string">'log'</span>](</span><br><span class="line">      <span class="string">`You are running Vue in development mode.\n`</span> +</span><br><span class="line">      <span class="string">`Make sure to turn on production mode when deploying for production.\n`</span> +</span><br><span class="line">      <span class="string">`See more tips at https://vuejs.org/guide/deployment.html`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>
<p>妙呀，我感觉我找到入口了，可以从这个文件和 core/index 文件开始看了。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-12-24</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Vue/" title="Vue">Vue </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://idmrchan.com/2017/12/24/vue-01-find-input/,Virgil Chan,从 Vue 源码学前端（01） —— 找到入口文件,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/02/02/git-server-create/" title="搭建 Git 服务器及配置 Hook">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/12/09/raspberry-startup-boot/" title="树莓派开机启动和后台运行 Python 程序">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>