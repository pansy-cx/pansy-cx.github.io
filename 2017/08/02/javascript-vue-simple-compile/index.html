<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Virigl,mrchan3668@gmail.com"><title>JavaScript 仿 vue 指令解析 · Virgil Chan</title><meta name="description" content="模仿 vue 实现指令解析。
效果123456789101112var compile = new Compile(&amp;#123;    el: '#compile',    data: &amp;#123;        a: 'test model',        b: 'hello World'   "><meta name="keywords" content="HTML,CSS,JavaScript,Vue,AngularJS,WebPack,UnderScore,System,Raspberry,Tool,Linux,WordPress,NodeJS,MongoDB,Git,Python"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="manifest" href="/manifest.json"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/favicon.png" style="width:127px;"><h3 title><a href="/">Virgil Chan</a></h3><div class="description"><p>间歇性凌云壮志，持续性混吃等死</p></div></div></div><ul class="social-links"><li><a href="http://www.feed43.com/6708067855351261.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/1953548815"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/pansy-cx"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>JavaScript 仿 vue 指令解析</a></h3></div><div class="post-content"><p>模仿 vue 实现指令解析。</p>
<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> compile = <span class="keyword">new</span> Compile(&#123;</span><br><span class="line">    el: <span class="string">'#compile'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        a: <span class="string">'test model'</span>,</span><br><span class="line">        b: <span class="string">'hello World'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        testToggle: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            alert(<span class="string">'successful'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"compile"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123; b &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    &#123;&#123; a &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">x-html</span>=<span class="string">"b"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">x-model</span>=<span class="string">"a"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">x-on:click</span>=<span class="string">"testToggle"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先创建一个名为 Compile 的函数，并在原型链上添加实现方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> el = vm.$el</span><br><span class="line">    <span class="comment">// 获取文档碎片</span></span><br><span class="line">    <span class="keyword">var</span> fragment = nodeFragment(el)</span><br><span class="line">    <span class="comment">// 对指令进行解析</span></span><br><span class="line">    compileElement(fragment, vm)</span><br><span class="line">    <span class="comment">// 添加 DOM</span></span><br><span class="line">    el.appendChild(fragment)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="createDocumentFragment"><a href="#createDocumentFragment" class="headerlink" title="createDocumentFragment"></a>createDocumentFragment</h5><p>首先获取文档碎片(片段)  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nodeFragment</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fragment = <span class="built_in">document</span>.createDocumentFragment()</span><br><span class="line">    <span class="keyword">var</span> child</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (child = el.firstChild) &#123;</span><br><span class="line">        fragment.appendChild(child)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fragment</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里创建了一个 DocumentFragment 节点，看看 MDN 对 DocumentFragment 的解释：<a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/createDocumentFragment" target="_blank">Document.createDocumentFragment()</a></p>
<blockquote>
<p>DocumentFragments are DOM Nodes. They are never part of the main DOM tree. The usual use case is to create the document fragment, append elements to the document fragment and then append the document fragment to the DOM tree. In the DOM tree, the document fragment is replaced by all its children.<br>Since the document fragment is in memory and not part of the main DOM tree, appending children to it does not cause page reflow (computation of element’s position and geometry). Consequently, using document fragments often results in better performance.</p>
</blockquote>
<p>DocumentFragments 是一个文档节点，用于创建文本片段，文档片段保存在内存里，修改后在添加到 DOM Tree 里，这样避免了直接操作文档节点导致页面不断刷新带来的性能下降。</p>
<p>获取到文本节点之后，在对文本节点进行解析  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileElement</span>(<span class="params">frag, vm</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> childNode = frag.childNodes</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="regexp">/\&#123;\&#123;((?:.|\n)+?)\&#125;\&#125;/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对每个节点进行判断</span></span><br><span class="line">    slice.call(childNode).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 如果是元素节点</span></span><br><span class="line">        <span class="keyword">if</span> (isElement(node)) &#123;</span><br><span class="line">            compileNode(node, vm)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isTextType(node) &amp;&amp; reg.test(node.textContent)) &#123;</span><br><span class="line">             <span class="comment">// 如果是文本节点</span></span><br><span class="line">            <span class="keyword">var</span> exp = <span class="built_in">RegExp</span>.$<span class="number">1.</span>trim()</span><br><span class="line">            comopileText(node, vm, exp)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对子节点进行递归解析指令</span></span><br><span class="line">        <span class="keyword">if</span> (node.childNodes &amp;&amp; node.childNodes.length) &#123;</span><br><span class="line">            compileElement(node, vm)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是元素节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileNode</span>(<span class="params">node, vm</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取元素属性</span></span><br><span class="line">    <span class="keyword">var</span> nodeAttributes = node.attributes</span><br><span class="line">    <span class="keyword">var</span> name, value</span><br><span class="line">    <span class="comment">// 遍历元素属性</span></span><br><span class="line">    slice.call(nodeAttributes).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">attr</span>) </span>&#123;</span><br><span class="line">        name = attr.name</span><br><span class="line">        value = attr.value</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 判断是否是 x- 指令</span></span><br><span class="line">        <span class="keyword">if</span> (name.indexOf(<span class="string">'v-'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            name = name.slice(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name.indexOf(<span class="string">':'</span>) === <span class="number">-1</span>) &#123;</span><br><span class="line">                direct[name] &amp;&amp; direct[name](node, vm, value)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/(\D+):(\D+)/</span>.test(name)) &#123;</span><br><span class="line">                <span class="comment">// v-on:click</span></span><br><span class="line">                <span class="comment">// dir -&gt; on  exp -&gt; click</span></span><br><span class="line">                <span class="keyword">var</span> dir = <span class="built_in">RegExp</span>.$<span class="number">1</span></span><br><span class="line">                <span class="keyword">var</span> exp = <span class="built_in">RegExp</span>.$<span class="number">2</span></span><br><span class="line">                <span class="keyword">switch</span> (dir) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'on'</span> :</span><br><span class="line">                        direct.eventHandler(node, vm, exp, value)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'bind'</span> :</span><br><span class="line">                        direct.bindProp(node, vm, exp, value)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            node.removeAttribute(attr.name)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是文本节点<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">comopileText</span>(<span class="params">node, vm, exp</span>) </span>&#123;</span><br><span class="line">    direct.text(node, vm, exp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>direct 是具体渲染视图步骤的代码，就不贴上来了</p>
<p>其中渲染步骤有个额函数需要注意</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params">node, vm, prop, dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> updaterFn = updater[dir + <span class="string">'Updater'</span>]</span><br><span class="line">    <span class="keyword">var</span> val = vm[prop]</span><br><span class="line">    updaterFn &amp;&amp; updaterFn(node, val)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Watcher(vm, prop, <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">        updaterFn &amp;&amp; updaterFn(node, value)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实例化了 Watcher 对象，将修改视图的方法添加给了 Watcher，这点接下来会讲到</p>
<p>对指令解析完后，在添加到 DOM Tree里</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$el.appendChild(<span class="keyword">this</span>.$fragment);</span><br></pre></td></tr></table></figure>
<p>这样就完成了简单地指令解析啦，当然，Vue本身的指令比这复杂的多，我只是实现了最简单的功能</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-08-02</span><i class="fa fa-tag"></i><a class="tag" href="/tags/JavaScript/" title="JavaScript">JavaScript </a><a class="tag" href="/tags/Vue/" title="Vue">Vue </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://idmrchan.com/2017/08/02/javascript-vue-simple-compile/,Virgil Chan,JavaScript 仿 vue 指令解析,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/08/02/javascript-vue-data-binding/" title="Vue 数据绑定与视图更新">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/07/23/http-detailed/" title="从输入URL到页面呈现内容发生了什么">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>