<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Virigl,mrchan3668@gmail.com"><title>HLS 源码分析（1） · Virgil Chan</title><meta name="description" content="这篇文章梳理一下 hls.js 播放 m3u8 文件的主流程。
首先，hls 先请求 m3u8文件，获取到每个切片的地址，然后按顺序请求这些 ts，解析出 ts 当中的音视频资源，使用 Media Source Extensions 将 buffer 内容进行合流，组成一个可播的媒体资源文件。
Me"><meta name="keywords" content="HTML,CSS,JavaScript,Vue,AngularJS,WebPack,UnderScore,System,Raspberry,Tool,Linux,WordPress,NodeJS,MongoDB,Git,Python"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="manifest" href="/manifest.json"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/favicon.png" style="width:127px;"><h3 title><a href="/">Virgil Chan</a></h3><div class="description"><p>间歇性凌云壮志，持续性混吃等死</p></div></div></div><ul class="social-links"><li><a href="http://www.feed43.com/6708067855351261.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/1953548815"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/pansy-cx"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>HLS 源码分析（1）</a></h3></div><div class="post-content"><p>这篇文章梳理一下 <a href="https://github.com/video-dev/hls.js" target="_blank" rel="noopener">hls.js</a> 播放 m3u8 文件的主流程。</p>
<p>首先，hls 先请求 m3u8文件，获取到每个切片的地址，然后按顺序请求这些 ts，解析出 ts 当中的音视频资源，使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaSource" target="_blank" rel="noopener">Media Source Extensions</a> 将 buffer 内容进行合流，组成一个可播的媒体资源文件。</p>
<h3 id="Media-Source-Extensions"><a href="#Media-Source-Extensions" class="headerlink" title="Media Source Extensions"></a>Media Source Extensions</h3><p>这是浏览器提供的一个 API，让 JS 通过 API 控制 Video 资源。官方例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vidElement = <span class="built_in">document</span>.querySelector(<span class="string">'video'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.MediaSource) &#123;</span><br><span class="line">  <span class="keyword">var</span> mediaSource = <span class="keyword">new</span> MediaSource();</span><br><span class="line">  vidElement.src = URL.createObjectURL(mediaSource);</span><br><span class="line">  mediaSource.addEventListener(<span class="string">'sourceopen'</span>, sourceOpen);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"The Media Source Extensions API is not supported."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sourceOpen</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  URL.revokeObjectURL(vidElement.src);</span><br><span class="line">  <span class="keyword">var</span> mime = <span class="string">'video/webm; codecs="opus, vp09.00.10.08"'</span>;</span><br><span class="line">  <span class="keyword">var</span> mediaSource = e.target;</span><br><span class="line">  <span class="keyword">var</span> sourceBuffer = mediaSource.addSourceBuffer(mime);</span><br><span class="line">  <span class="keyword">var</span> videoUrl = <span class="string">'droid.webm'</span>;</span><br><span class="line">  fetch(videoUrl)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> response.arrayBuffer();</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">arrayBuffer</span>) </span>&#123;</span><br><span class="line">      sourceBuffer.addEventListener(<span class="string">'updateend'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!sourceBuffer.updating &amp;&amp; mediaSource.readyState === <span class="string">'open'</span>) &#123;</span><br><span class="line">          mediaSource.endOfStream();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      sourceBuffer.appendBuffer(arrayBuffer);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这个 API，就可以把切片 buffer 添加到 Video 里。</p>
<h3 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;video id=<span class="string">"video"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">var</span> video = <span class="built_in">document</span>.getElementById(<span class="string">'video'</span>);</span><br><span class="line">  <span class="keyword">var</span> videoSrc = <span class="string">'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'</span>;</span><br><span class="line">  <span class="keyword">if</span> (Hls.isSupported()) &#123;</span><br><span class="line">    <span class="keyword">var</span> hls = <span class="keyword">new</span> Hls();</span><br><span class="line">    hls.loadSource(videoSrc);</span><br><span class="line">    hls.attachMedia(video);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (video.canPlayType(<span class="string">'application/vnd.apple.mpegurl'</span>)) &#123;</span><br><span class="line">    video.src = videoSrc;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到，外部调用很简单，主要是三步，初始化 Hls 实例，加载 video 资源，挂载 Video DOM。</p>
<h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(<span class="params">userConfig: Partial&lt;HlsConfig&gt; = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// 配置 config</span></span><br><span class="line">  <span class="keyword">const</span> config = (<span class="keyword">this</span>.config = mergeConfig(Hls.DefaultConfig, userConfig));</span><br><span class="line">  <span class="keyword">this</span>.userConfig = userConfig;</span><br><span class="line">  enableLogs(config.debug);</span><br><span class="line">  <span class="keyword">this</span>._autoLevelCapping = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (config.progressive) &#123;</span><br><span class="line">    enableStreamingMode(config);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加各种 controller</span></span><br><span class="line">  <span class="keyword">const</span> abrController = (<span class="keyword">this</span>.abrController = <span class="keyword">new</span> config.abrController(<span class="keyword">this</span>));</span><br><span class="line">  <span class="keyword">const</span> bufferController = <span class="keyword">new</span> config.bufferController(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">const</span> capLevelController = (<span class="keyword">this</span>.capLevelController = <span class="keyword">new</span> config.capLevelController(<span class="keyword">this</span>));</span><br><span class="line">  <span class="keyword">const</span> fpsController = <span class="keyword">new</span> config.fpsController(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">const</span> playListLoader = <span class="keyword">new</span> PlaylistLoader(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">const</span> keyLoader = <span class="keyword">new</span> KeyLoader(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">const</span> id3TrackController = <span class="keyword">new</span> ID3TrackController(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">// network controllers</span></span><br><span class="line">  <span class="keyword">const</span> levelController = (<span class="keyword">this</span>.levelController = <span class="keyword">new</span> LevelController(<span class="keyword">this</span>));</span><br><span class="line">  <span class="comment">// FragmentTracker must be defined before StreamController because the order of event handling is important</span></span><br><span class="line">  <span class="keyword">const</span> fragmentTracker = <span class="keyword">new</span> FragmentTracker(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">const</span> streamController = (<span class="keyword">this</span>.streamController = <span class="keyword">new</span> StreamController(</span><br><span class="line">    <span class="keyword">this</span>,</span><br><span class="line">    fragmentTracker</span><br><span class="line">  ));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Level Controller initiates loading after all controllers have received MANIFEST_PARSED</span></span><br><span class="line">  <span class="comment">// 调用 startLoad，开始解析资源</span></span><br><span class="line">  levelController.onParsedComplete = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config.autoStartLoad || streamController.forceStartLoad) &#123;</span><br><span class="line">      <span class="keyword">this</span>.startLoad(config.startPosition);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Cap level controller uses streamController to flush the buffer</span></span><br><span class="line">  capLevelController.setStreamController(streamController);</span><br><span class="line">  <span class="comment">// fpsController uses streamController to switch when frames are being dropped</span></span><br><span class="line">  fpsController.setStreamController(streamController);</span><br><span class="line">  <span class="keyword">const</span> networkControllers = [levelController, streamController];</span><br><span class="line">  <span class="keyword">this</span>.networkControllers = networkControllers;</span><br><span class="line">  <span class="keyword">const</span> coreComponents = [</span><br><span class="line">    playListLoader,</span><br><span class="line">    keyLoader,</span><br><span class="line">    abrController,</span><br><span class="line">    bufferController,</span><br><span class="line">    capLevelController,</span><br><span class="line">    fpsController,</span><br><span class="line">    id3TrackController,</span><br><span class="line">    fragmentTracker,</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// 根据 config 生成的 controller</span></span><br><span class="line">  <span class="keyword">this</span>.audioTrackController = <span class="keyword">this</span>.createController(</span><br><span class="line">    config.audioTrackController,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    networkControllers</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.coreComponents = coreComponents;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化的过程很简单，主要处理传入的 config，以及初始化各种 controller。由于 Hls 内部都是使用事件来进行通知，所以需要在初始化时将各种事件监听挂载上去。</p>
<h5 id="loadSource"><a href="#loadSource" class="headerlink" title="loadSource"></a>loadSource</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">loadSource(url: <span class="built_in">string</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.stopLoad();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">this</span>.trigger(Events.MANIFEST_LOADING, &#123; url: url &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loadSource 本身并没有做什么，只是触发了 MANIFEST_LOADING 这个事件，那么有哪些 controller 在监听这些事件：</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnw4sgf8a7j30oq0ya7cv.jpg" alt="image-20210222110357146" style="zoom:50%;"></p>
<p>看一下 stream-controller 做了什么</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(<span class="params">hls: Hls</span>) &#123;</span><br><span class="line">  hls.on(Events.MANIFEST_LOADING, <span class="keyword">this</span>.onManifestLoading, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> onManifestLoading() &#123;</span><br><span class="line">  <span class="comment">// reset buffer on manifest loading</span></span><br><span class="line">  <span class="keyword">this</span>.log(<span class="string">'Trigger BUFFER_RESET'</span>);</span><br><span class="line">  <span class="keyword">this</span>.hls.trigger(Events.BUFFER_RESET, <span class="literal">undefined</span>);</span><br><span class="line">  <span class="keyword">this</span>.fragmentTracker.removeAllFragments();</span><br><span class="line">  <span class="keyword">this</span>.stalled = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">this</span>.startPosition = <span class="keyword">this</span>.lastCurrentTime = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>.fragPlaying = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仅是做了重置脏数据的操作，其他的 controller 也是类似操作，真正加载资源的是 playlist-loader 这个 controller，摘取某些重要的代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// playlist-loader.ts</span></span><br><span class="line"><span class="keyword">private</span> onManifestLoading(</span><br><span class="line">  event: Events.MANIFEST_LOADING,</span><br><span class="line">  data: ManifestLoadingData</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; url &#125; = data;</span><br><span class="line">  <span class="keyword">this</span>.checkAgeHeader = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">this</span>.load(&#123;</span><br><span class="line">    id: <span class="literal">null</span>,</span><br><span class="line">    groupId: <span class="literal">null</span>,</span><br><span class="line">    level: <span class="number">0</span>,</span><br><span class="line">    responseType: <span class="string">'text'</span>,</span><br><span class="line">    <span class="keyword">type</span>: PlaylistContextType.MANIFEST,</span><br><span class="line">    url,</span><br><span class="line">    deliveryDirectives: <span class="literal">null</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> load(context: PlaylistLoaderContext): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> loaderCallbacks = &#123;</span><br><span class="line">    onSuccess: <span class="keyword">this</span>.loadsuccess.bind(<span class="keyword">this</span>),</span><br><span class="line">    onError: <span class="keyword">this</span>.loaderror.bind(<span class="keyword">this</span>),</span><br><span class="line">    onTimeout: <span class="keyword">this</span>.loadtimeout.bind(<span class="keyword">this</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">	<span class="comment">// loader 可以由外部传入，默认使用 xhr</span></span><br><span class="line">  loader.load(context, loaderConfig, loaderCallbacks);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 请求成功后，执行这个函数</span></span><br><span class="line"><span class="keyword">private</span> loadsuccess(</span><br><span class="line">  response: LoaderResponse,</span><br><span class="line">  stats: LoaderStats,</span><br><span class="line">  context: PlaylistLoaderContext,</span><br><span class="line">  networkDetails: <span class="built_in">any</span> = <span class="literal">null</span></span><br><span class="line">): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">string</span> = response.data <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">  <span class="comment">// 如果不是 #EXTM3U 开头，说明不是 m3u8 文件，抛错</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">string</span>.indexOf(<span class="string">'#EXTM3U'</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.handleManifestParsingError(</span><br><span class="line">      response,</span><br><span class="line">      context,</span><br><span class="line">      <span class="string">'no EXTM3U delimiter'</span>,</span><br><span class="line">      networkDetails</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stats.parsing.start = performance.now();</span><br><span class="line">	<span class="comment">// 如果存在 #EXT-X-TARGETDURATION，说明这是一个包含 ts 的播放列表</span></span><br><span class="line">	<span class="comment">// 如果不存在，说明是一个 master playlist，需要根据用户选择的播放分辨率选择不同质量的子 playlist</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="built_in">string</span>.indexOf(<span class="string">'#EXTINF:'</span>) &gt; <span class="number">0</span> ||</span><br><span class="line">    <span class="built_in">string</span>.indexOf(<span class="string">'#EXT-X-TARGETDURATION:'</span>) &gt; <span class="number">0</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">this</span>.handleTrackOrLevelPlaylist(response, stats, context, networkDetails);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.handleMasterPlaylist(response, stats, context, networkDetails);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// parser m3u8</span></span><br><span class="line"><span class="keyword">private</span> handleTrackOrLevelPlaylist(</span><br><span class="line">  response: LoaderResponse,</span><br><span class="line">  stats: LoaderStats,</span><br><span class="line">  context: PlaylistLoaderContext,</span><br><span class="line">  networkDetails: <span class="built_in">any</span></span><br><span class="line">): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> hls = <span class="keyword">this</span>.hls;</span><br><span class="line">  <span class="keyword">const</span> &#123; id, level, <span class="keyword">type</span> &#125; = context;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> levelDetails: LevelDetails = M3U8Parser.parseLevelPlaylist(</span><br><span class="line">    response.data <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">    url,</span><br><span class="line">    levelId!,</span><br><span class="line">    levelType,</span><br><span class="line">    levelUrlId!</span><br><span class="line">  );</span><br><span class="line">  context.levelDetails = levelDetails;</span><br><span class="line">  <span class="keyword">this</span>.handlePlaylistLoaded(response, stats, context, networkDetails);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>handlePlaylistLoaded</code> 函数触发了 <code>Events.LEVEL_LOADED</code> 事件，stream-controller 收到事件后开始请求 ts。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stream-controller.ts</span></span><br><span class="line"><span class="keyword">class</span> StreamController <span class="keyword">extends</span> BaseStreamController &#123;</span><br><span class="line">  <span class="keyword">private</span> onLevelLoaded(event: Events.LEVEL_LOADED, data: LevelLoadedData) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// trigger handler right now</span></span><br><span class="line">    <span class="keyword">this</span>.tick();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 调用 tick 后走到这里</span></span><br><span class="line">  <span class="keyword">protected</span> doTick() &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">this</span>.state) &#123;</span><br><span class="line">     	<span class="comment">// 当前状态 闲置</span></span><br><span class="line">      <span class="keyword">case</span> State.IDLE:</span><br><span class="line">        <span class="keyword">this</span>.doTickIdle();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> BaseStreamController <span class="keyword">extends</span> TaskLoop &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> TaskLoop &#123;</span><br><span class="line">  <span class="keyword">private</span> readonly _boundTick: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  <span class="keyword">private</span> _tickCallCount = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> _tickTimer: <span class="built_in">number</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>._boundTick = <span class="keyword">this</span>.tick.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> clearNextTick(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._tickTimer) &#123;</span><br><span class="line">      self.clearTimeout(<span class="keyword">this</span>._tickTimer);</span><br><span class="line">      <span class="keyword">this</span>._tickTimer = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Will call the subclass doTick implementation in this main loop tick</span></span><br><span class="line"><span class="comment">   * or in the next one (via setTimeout(,0)) in case it has already been called</span></span><br><span class="line"><span class="comment">   * in this tick (in case this is a re-entrant call).</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> tick(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>._tickCallCount++;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._tickCallCount === <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 由 subclass 实现</span></span><br><span class="line">      <span class="keyword">this</span>.doTick();</span><br><span class="line">      <span class="comment">// re-entrant call to tick from previous doTick call stack</span></span><br><span class="line">      <span class="comment">// -&gt; schedule a call on the next main loop iteration to process this task processing request</span></span><br><span class="line">      <span class="comment">// 除非多线程环境，否则我理解不会走进这里</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>._tickCallCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// make sure only one timer exists at any time at max</span></span><br><span class="line">        <span class="keyword">this</span>.clearNextTick();</span><br><span class="line">        <span class="keyword">this</span>._tickTimer = self.setTimeout(<span class="keyword">this</span>._boundTick, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>._tickCallCount = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过上面一系列的调用之后，函数走到了 doTickIdle，<code>doTickIdle -&gt; loadFragment -&gt; super.loadFragment -&gt; _loadFragForPlayback</code> 这里我们先不关心这条调用链做了什么，总之，最后走到了 BaseStreamController  的 loadFragment 方法。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> BaseStreamController <span class="keyword">extends</span> TaskLoop &#123;</span><br><span class="line">  <span class="keyword">private</span> _loadFragForPlayback(</span><br><span class="line">    frag: Fragment,</span><br><span class="line">    levelDetails: LevelDetails,</span><br><span class="line">    targetBufferTime: <span class="built_in">number</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 请求 ts 后进到这个 callback</span></span><br><span class="line">    <span class="keyword">const</span> progressCallback: FragmentLoadProgressCallback = (</span><br><span class="line">      data: FragLoadedData</span><br><span class="line">    ) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 由 sub class 实现</span></span><br><span class="line">      <span class="keyword">this</span>._handleFragmentLoadProgress(data);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>._doFragLoad(</span><br><span class="line">      frag,</span><br><span class="line">      levelDetails,</span><br><span class="line">      targetBufferTime,</span><br><span class="line">      progressCallback</span><br><span class="line">    ).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">this</span>._handleFragmentLoadComplete(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> StreamController <span class="keyword">extends</span> BaseStreamController &#123;</span><br><span class="line">  <span class="keyword">protected</span> _handleFragmentLoadProgress(data: FragLoadedData) &#123;</span><br><span class="line">    <span class="comment">// payload 是 ts 数据</span></span><br><span class="line">    <span class="keyword">const</span> &#123; frag, part, payload &#125; = data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// transmux the MPEG-TS data to ISO-BMFF segments</span></span><br><span class="line">    <span class="keyword">const</span> transmuxer = (<span class="keyword">this</span>.transmuxer =</span><br><span class="line">      <span class="keyword">this</span>.transmuxer ||</span><br><span class="line">      <span class="keyword">new</span> TransmuxerInterface(</span><br><span class="line">        <span class="keyword">this</span>.hls,</span><br><span class="line">        PlaylistLevelType.MAIN,</span><br><span class="line">      	<span class="comment">// transmux 成功后的回调函数</span></span><br><span class="line">        <span class="keyword">this</span>._handleTransmuxComplete.bind(<span class="keyword">this</span>),</span><br><span class="line">        <span class="keyword">this</span>._handleTransmuxerFlush.bind(<span class="keyword">this</span>)</span><br><span class="line">      ));</span><br><span class="line">    transmuxer.push(</span><br><span class="line">      payload,</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 TransmuxerInterface 是 Transmuxer 这个类对外暴露的接口，TransmuxerInterface 通过浏览器的 web worker API，将 Transmuxer 复杂的计算操作放到其他线程处理，以免阻塞 JS 线程。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> work <span class="keyword">from</span> <span class="string">'webworkify-webpack'</span>;</span><br><span class="line"><span class="keyword">class</span> TransmuxerInterface &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    hls: Hls,</span></span><br><span class="line"><span class="params">    id: PlaylistLevelType,</span></span><br><span class="line"><span class="params">    onTransmuxComplete: (transmuxResult: TransmuxerResult) =&gt; <span class="built_in">void</span>,</span></span><br><span class="line"><span class="params">    onFlush: (chunkMeta: ChunkMetadata) =&gt; <span class="built_in">void</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">      <span class="comment">// 如果 work 不可用，则使用 transmuxer，二者是一样的操作</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        worker = <span class="keyword">this</span>.worker = work(</span><br><span class="line">          <span class="built_in">require</span>.resolve(<span class="string">'../demux/transmuxer-worker.ts'</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">this</span>.onwmsg = <span class="keyword">this</span>.onWorkerMessage.bind(<span class="keyword">this</span>);</span><br><span class="line">        worker.addEventListener(<span class="string">'message'</span>, <span class="keyword">this</span>.onwmsg);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">this</span>.transmuxer = <span class="keyword">new</span> Transmuxer(</span><br><span class="line">          <span class="keyword">this</span>.observer,</span><br><span class="line">          typeSupported,</span><br><span class="line">          config,</span><br><span class="line">          vendor</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">this</span>.worker = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   	&#125;</span><br><span class="line">  push (...) &#123;</span><br><span class="line">    <span class="keyword">if</span> (worker) &#123;</span><br><span class="line">      worker.postMessage(</span><br><span class="line">        &#123;</span><br><span class="line">          cmd: <span class="string">'demux'</span>,</span><br><span class="line">          data,</span><br><span class="line">          decryptdata,</span><br><span class="line">          chunkMeta,</span><br><span class="line">          state,</span><br><span class="line">        &#125;,</span><br><span class="line">        data <span class="keyword">instanceof</span> <span class="built_in">ArrayBuffer</span> ? [data] : []</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (transmuxer) &#123;</span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      <span class="keyword">const</span> transmuxResult = transmuxer.push(</span><br><span class="line">        data,</span><br><span class="line">        decryptdata,</span><br><span class="line">        chunkMeta,</span><br><span class="line">        state</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (isPromise(transmuxResult)) &#123;</span><br><span class="line">        transmuxResult.then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.handleTransmuxComplete(data);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// transmux 结束，实际执行的是 new TransmuxerInterface 传入的 onTransmuxComplete</span></span><br><span class="line">        <span class="keyword">this</span>.handleTransmuxComplete(transmuxResult <span class="keyword">as</span> TransmuxerResult);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看一下 onTransmuxComplete 做了什么</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stream-controller.ts</span></span><br><span class="line"><span class="keyword">private</span> _handleTransmuxComplete(transmuxResult: TransmuxerResult) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; remuxResult, chunkMeta &#125; = transmuxResult;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; video, text, id3, initSegment &#125; = remuxResult;</span><br><span class="line">  <span class="keyword">const</span> audio = <span class="keyword">this</span>.altAudio ? <span class="literal">undefined</span> : remuxResult.audio;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (video &amp;&amp; remuxResult.independent !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// 跳过...</span></span><br><span class="line">    <span class="keyword">this</span>.bufferFragmentData(video, frag, part, chunkMeta);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (remuxResult.independent === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.backtrack(frag);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// audio ...</span></span><br><span class="line">  <span class="comment">// id3...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// base-stream-controller.ts</span></span><br><span class="line"><span class="keyword">protected</span> bufferFragmentData(</span><br><span class="line">  data: RemuxedTrack,</span><br><span class="line">  frag: Fragment,</span><br><span class="line">  part: Part | <span class="literal">null</span>,</span><br><span class="line">  chunkMeta: ChunkMetadata</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; data1, data2 &#125; = data;</span><br><span class="line">  <span class="keyword">let</span> buffer = data1;</span><br><span class="line">  <span class="keyword">if</span> (data1 &amp;&amp; data2) &#123;</span><br><span class="line">    <span class="comment">// Combine the moof + mdat so that we buffer with a single append</span></span><br><span class="line">    buffer = appendUint8Array(data1, data2);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> segment: BufferAppendingData = &#123;</span><br><span class="line">    <span class="keyword">type</span>: data.type,</span><br><span class="line">    data: buffer,</span><br><span class="line">    frag,</span><br><span class="line">    part,</span><br><span class="line">    chunkMeta,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">this</span>.hls.trigger(Events.BUFFER_APPENDING, segment);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// buffer-controller.ts</span></span><br><span class="line"><span class="comment">// hls.on(Events.BUFFER_APPENDING, this.onBufferAppending, this);</span></span><br><span class="line"><span class="keyword">protected</span> onBufferAppending(</span><br><span class="line">  event: Events.BUFFER_APPENDING,</span><br><span class="line">  eventData: BufferAppendingData</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// data 是上面经过 transmuxer 处理后的数据</span></span><br><span class="line">  <span class="keyword">const</span> &#123; data, <span class="keyword">type</span>, frag, part, chunkMeta &#125; = eventData;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> operation: BufferOperation = &#123;</span><br><span class="line">    execute: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">this</span>.appendExecutor(data, <span class="keyword">type</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// append 后，经过一系列操作，会触发 operation.execute</span></span><br><span class="line">  operationQueue.append(operation, <span class="keyword">type</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// sourcebuffer append</span></span><br><span class="line"><span class="keyword">private</span> appendExecutor(data: <span class="built_in">Uint8Array</span>, <span class="keyword">type</span>: SourceBufferName) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; operationQueue, sourceBuffer &#125; = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">const</span> sb = sourceBuffer[<span class="keyword">type</span>];</span><br><span class="line">  sb.ended = <span class="literal">false</span>;</span><br><span class="line">  sb.appendBuffer(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的过程可以简化成：加载 ts 数据 -&gt; 解析 ts 数据，将其中的音视频数据拿出来 -&gt; 调用 MSE 接口，将数据 append 到 sourcebuffer。</p>
<h3 id="transmuxer"><a href="#transmuxer" class="headerlink" title="transmuxer"></a>transmuxer</h3><p>继续刚才的 transmuxer 代码</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// transmuxer.ts</span></span><br><span class="line">push(</span><br><span class="line">  data: <span class="built_in">ArrayBuffer</span>,</span><br><span class="line">  decryptdata: LevelKey | <span class="literal">null</span>,</span><br><span class="line">  chunkMeta: ChunkMetadata,</span><br><span class="line">  state?: TransmuxState</span><br><span class="line">): TransmuxerResult | <span class="built_in">Promise</span>&lt;TransmuxerResult&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> uintData: <span class="built_in">Uint8Array</span> = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(data);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 最终走到 transmuxUnencrypted 函数</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">this</span>.transmux(</span><br><span class="line">    uintData,</span><br><span class="line">    keyData,</span><br><span class="line">    timeOffset,</span><br><span class="line">    accurateTimeOffset,</span><br><span class="line">    chunkMeta</span><br><span class="line">  );</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> transmuxUnencrypted(</span><br><span class="line">  data: <span class="built_in">Uint8Array</span>,</span><br><span class="line">  timeOffset: <span class="built_in">number</span>,</span><br><span class="line">  accurateTimeOffset: <span class="built_in">boolean</span>,</span><br><span class="line">  chunkMeta: ChunkMetadata</span><br><span class="line">): TransmuxerResult &#123;</span><br><span class="line">  <span class="comment">// 将 ts 格式里的 音视频数据提取出来</span></span><br><span class="line">  <span class="keyword">const</span> &#123; audioTrack, avcTrack, id3Track, textTrack &#125; = (<span class="keyword">this</span>.demuxer <span class="keyword">as</span> Demuxer).demux(data, timeOffset, <span class="literal">false</span>);</span><br><span class="line">  <span class="comment">// 在混流成浏览器能播放的格式</span></span><br><span class="line">  <span class="keyword">const</span> remuxResult = <span class="keyword">this</span>.remuxer!.remux(</span><br><span class="line">    audioTrack,</span><br><span class="line">    avcTrack,</span><br><span class="line">    id3Track,</span><br><span class="line">    textTrack,</span><br><span class="line">    timeOffset,</span><br><span class="line">    accurateTimeOffset,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    remuxResult,</span><br><span class="line">    chunkMeta,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，transmuxer 分为两步，Demux 和 Remux。</p>
<p>Mux 是 Multiplex 的缩写，在这里是「混流」的意思，Demux 就是将混流解开的操作，将混流里的音视频，字幕等数据解开，在 Remux 成浏览器能播放的视频格式。而不同格式的 demux 和 remux 方法也不一样</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// transmuxer.ts</span></span><br><span class="line"><span class="keyword">const</span> muxConfig: MuxConfig[] = [</span><br><span class="line">  &#123; demux: TSDemuxer, remux: MP4Remuxer &#125;,</span><br><span class="line">  &#123; demux: MP4Demuxer, remux: PassThroughRemuxer &#125;,</span><br><span class="line">  &#123; demux: AACDemuxer, remux: MP4Remuxer &#125;,</span><br><span class="line">  &#123; demux: MP3Demuxer, remux: MP4Remuxer &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>拿 TSDemuxer 简单的分析一下，可以看出和上一篇 <a href="https://idmrchan.com/2021/02/19/hls-protocol-analysis/">hls 协议详解</a> 描述的一致</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tsdemuxer.ts</span></span><br><span class="line"><span class="keyword">public</span> demux(</span><br><span class="line">  data: <span class="built_in">Uint8Array</span>,</span><br><span class="line">  timeOffset: <span class="built_in">number</span>,</span><br><span class="line">  isSampleAes = <span class="literal">false</span>,</span><br><span class="line">  flush = <span class="literal">false</span></span><br><span class="line">): DemuxerResult &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isSampleAes) &#123;</span><br><span class="line">    <span class="keyword">this</span>.sampleAes = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> pes: PES | <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> avcTrack = <span class="keyword">this</span>._avcTrack;</span><br><span class="line">  <span class="keyword">const</span> audioTrack = <span class="keyword">this</span>._audioTrack;</span><br><span class="line">  <span class="keyword">const</span> id3Track = <span class="keyword">this</span>._id3Track;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> avcId = avcTrack.pid;</span><br><span class="line">  <span class="keyword">let</span> avcData = avcTrack.pesData;</span><br><span class="line">  <span class="keyword">let</span> audioId = audioTrack.pid;</span><br><span class="line">  <span class="keyword">let</span> id3Id = id3Track.pid;</span><br><span class="line">  <span class="keyword">let</span> audioData = audioTrack.pesData;</span><br><span class="line">  <span class="keyword">let</span> id3Data = id3Track.pesData;</span><br><span class="line">  <span class="keyword">let</span> unknownPIDs = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> pmtParsed = <span class="keyword">this</span>.pmtParsed;</span><br><span class="line">  <span class="keyword">let</span> pmtId = <span class="keyword">this</span>._pmtId;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> len = data.length;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.remainderData) &#123;</span><br><span class="line">    data = appendUint8Array(<span class="keyword">this</span>.remainderData, data);</span><br><span class="line">    len = data.length;</span><br><span class="line">    <span class="keyword">this</span>.remainderData = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 一个 Packet 最少是 188 字节，如果少于 188，就存下来，加在下个片段</span></span><br><span class="line">  <span class="keyword">if</span> (len &lt; <span class="number">188</span> &amp;&amp; !flush) &#123;</span><br><span class="line">    <span class="keyword">this</span>.remainderData = data;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      audioTrack,</span><br><span class="line">      avcTrack,</span><br><span class="line">      id3Track,</span><br><span class="line">      textTrack: <span class="keyword">this</span>._txtTrack,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> syncOffset = <span class="built_in">Math</span>.max(<span class="number">0</span>, TSDemuxer.syncOffset(data));</span><br><span class="line">  <span class="comment">// 把剩余不满 188 的部分存下来，放到下一个 ts 一起解析</span></span><br><span class="line">  len -= (len + syncOffset) % <span class="number">188</span>;</span><br><span class="line">  <span class="keyword">if</span> (len &lt; data.byteLength &amp;&amp; !flush) &#123;</span><br><span class="line">    <span class="keyword">this</span>.remainderData = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(</span><br><span class="line">      data.buffer,</span><br><span class="line">      len,</span><br><span class="line">      data.buffer.byteLength - len</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * loop through TS packets</span></span><br><span class="line"><span class="comment">   * 第1个字节， sync byte，固定为 0x47</span></span><br><span class="line"><span class="comment">   * 第2个字节，前三位分别是 Transport Error Indicator (TEI)，Payload Unit Start Indicator，Transport Priority</span></span><br><span class="line"><span class="comment">   * 第2个字节后 5 位 + 第3个字节 8 位 = 13 位，为 PID</span></span><br><span class="line"><span class="comment">   * 第4个字节，分别是 2位 Transport Scrambling control (TSC)，2位 Adaptation field exist，4位 Continuity counter</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> start = syncOffset; start &lt; len; start += <span class="number">188</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data[start] === <span class="number">0x47</span>) &#123;</span><br><span class="line">      <span class="comment">// 0x40 0100 0000。判断 Payload Unit Start Indicator 是否为 1</span></span><br><span class="line">      <span class="comment">// 一个 ts 包往往放不下 PES 包的，那么需要截取发送，就是通过这个字段区分，如果为 1，说明这个 ts 是一个包头</span></span><br><span class="line">      <span class="keyword">const</span> stt = !!(data[start + <span class="number">1</span>] &amp; <span class="number">0x40</span>);</span><br><span class="line">      <span class="comment">// 取 data[start + 1] 的后 5 位和 data[str+2] 的 8 位组合成 PID</span></span><br><span class="line">      <span class="comment">// pid is a 13-bit field starting at the last bit of TS[1]</span></span><br><span class="line">      <span class="keyword">const</span> pid = ((data[start + <span class="number">1</span>] &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">8</span>) + data[start + <span class="number">2</span>];</span><br><span class="line">      <span class="comment">// Adaptation field exist 适配域存在标识</span></span><br><span class="line">      <span class="keyword">const</span> atf = (data[start + <span class="number">3</span>] &amp; <span class="number">0x30</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// if an adaption field is present, its length is specified by the fifth byte of the TS packet header.</span></span><br><span class="line">      <span class="keyword">let</span> offset: <span class="built_in">number</span>;</span><br><span class="line">      <span class="comment">// atf 2 bit： 第1位表示是否有 Adaptation field，第2位表示是否有 payload</span></span><br><span class="line">      <span class="comment">// 第1位为1，</span></span><br><span class="line">      <span class="keyword">if</span> (atf &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// data[start + 4] 表示 Adaptation field 占多少个字节长度</span></span><br><span class="line">        <span class="comment">// demux 不关心 Adaptation field 里的内容，跳过</span></span><br><span class="line">        offset = start + <span class="number">5</span> + data[start + <span class="number">4</span>];</span><br><span class="line">        <span class="comment">// continue if there is only adaptation field</span></span><br><span class="line">        <span class="keyword">if</span> (offset === start + <span class="number">188</span>) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 跳过前 4 个字节（ TS 包开头的固定部分）</span></span><br><span class="line">        offset = start + <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">switch</span> (pid) &#123;</span><br><span class="line">        <span class="comment">// 视频流 PID，通过解 PMT 包得出</span></span><br><span class="line">        <span class="keyword">case</span> avcId:</span><br><span class="line">          <span class="keyword">if</span> (stt) &#123;</span><br><span class="line">            <span class="comment">// 如果是包头，需要解 PES 格式</span></span><br><span class="line">            <span class="keyword">if</span> (avcData &amp;&amp; (pes = parsePES(avcData))) &#123;</span><br><span class="line">              <span class="keyword">this</span>.parseAVCPES(pes, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            avcData = &#123; data: [], size: <span class="number">0</span> &#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Video ES 数据</span></span><br><span class="line">          <span class="keyword">if</span> (avcData) &#123;</span><br><span class="line">            avcData.data.push(data.subarray(offset, start + <span class="number">188</span>));</span><br><span class="line">            avcData.size += start + <span class="number">188</span> - offset;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> audioId:</span><br><span class="line">          <span class="keyword">if</span> (stt) &#123;</span><br><span class="line">            <span class="keyword">if</span> (audioData &amp;&amp; (pes = parsePES(audioData))) &#123;</span><br><span class="line">              <span class="keyword">if</span> (audioTrack.isAAC) &#123;</span><br><span class="line">                <span class="keyword">this</span>.parseAACPES(pes);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.parseMPEGPES(pes);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            audioData = &#123; data: [], size: <span class="number">0</span> &#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (audioData) &#123;</span><br><span class="line">            audioData.data.push(data.subarray(offset, start + <span class="number">188</span>));</span><br><span class="line">            audioData.size += start + <span class="number">188</span> - offset;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> id3Id:</span><br><span class="line">          <span class="keyword">if</span> (stt) &#123;</span><br><span class="line">            <span class="keyword">if</span> (id3Data &amp;&amp; (pes = parsePES(id3Data))) &#123;</span><br><span class="line">              <span class="keyword">this</span>.parseID3PES(pes);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            id3Data = &#123; data: [], size: <span class="number">0</span> &#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (id3Data) &#123;</span><br><span class="line">            id3Data.data.push(data.subarray(offset, start + <span class="number">188</span>));</span><br><span class="line">            id3Data.size += start + <span class="number">188</span> - offset;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 0x0000, PAT 节目关联表 PID</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">          <span class="keyword">if</span> (stt) &#123;</span><br><span class="line">            <span class="comment">// 当前的 offset 跳过了 TS 包开头的固定部分，接下来的部分是数据包</span></span><br><span class="line">            <span class="comment">// 数据包的第一个字节是 pointer_field（程序特殊信息指针），表示数据从哪里开始</span></span><br><span class="line">            <span class="comment">// 这个字节数据都是 0x00</span></span><br><span class="line">            offset += data[offset] + <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          pmtId = <span class="keyword">this</span>._pmtId = parsePAT(data, offset);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> pmtId: &#123;</span><br><span class="line">          <span class="keyword">if</span> (stt) &#123;</span><br><span class="line">            offset += data[offset] + <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> parsedPIDs = parsePMT(</span><br><span class="line">            data,</span><br><span class="line">            offset,</span><br><span class="line">            <span class="keyword">this</span>.typeSupported.mpeg === <span class="literal">true</span> ||</span><br><span class="line">              <span class="keyword">this</span>.typeSupported.mp3 === <span class="literal">true</span>,</span><br><span class="line">            isSampleAes</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">          <span class="comment">// only update track id if track PID found while parsing PMT</span></span><br><span class="line">          <span class="comment">// this is to avoid resetting the PID to -1 in case</span></span><br><span class="line">          <span class="comment">// track PID transiently disappears from the stream</span></span><br><span class="line">          <span class="comment">// this could happen in case of transient missing audio samples for example</span></span><br><span class="line">          <span class="comment">// NOTE this is only the PID of the track as found in TS,</span></span><br><span class="line">          <span class="comment">// but we are not using this for MP4 track IDs.</span></span><br><span class="line">          avcId = parsedPIDs.avc;</span><br><span class="line">          <span class="keyword">if</span> (avcId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            avcTrack.pid = avcId;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          audioId = parsedPIDs.audio;</span><br><span class="line">          <span class="keyword">if</span> (audioId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            audioTrack.pid = audioId;</span><br><span class="line">            audioTrack.isAAC = parsedPIDs.isAAC;</span><br><span class="line">          &#125;</span><br><span class="line">          id3Id = parsedPIDs.id3;</span><br><span class="line">          <span class="keyword">if</span> (id3Id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            id3Track.pid = id3Id;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (unknownPIDs &amp;&amp; !pmtParsed) &#123;</span><br><span class="line">            logger.log(<span class="string">'reparse from beginning'</span>);</span><br><span class="line">            unknownPIDs = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// we set it to -188, the += 188 in the for loop will reset start to 0</span></span><br><span class="line">            start = syncOffset - <span class="number">188</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          pmtParsed = <span class="keyword">this</span>.pmtParsed = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x1fff</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          unknownPIDs = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.observer.emit(Events.ERROR, Events.ERROR, &#123;</span><br><span class="line">        <span class="keyword">type</span>: ErrorTypes.MEDIA_ERROR,</span><br><span class="line">        details: ErrorDetails.FRAG_PARSING_ERROR,</span><br><span class="line">        fatal: <span class="literal">false</span>,</span><br><span class="line">        reason: <span class="string">'TS packet did not start with 0x47'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  avcTrack.pesData = avcData;</span><br><span class="line">  audioTrack.pesData = audioData;</span><br><span class="line">  id3Track.pesData = id3Data;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    audioTrack,</span><br><span class="line">    avcTrack,</span><br><span class="line">    id3Track,</span><br><span class="line">    textTrack: <span class="keyword">this</span>._txtTrack,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个库没有去循环调用获取 PMT 节目表，仅取了第一个节目出来</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parsePAT</span>(<span class="params">data, offset</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// skip the PSI header and parse the first PMT entry</span></span><br><span class="line">  <span class="comment">// 0x1f -&gt; 0001 1111</span></span><br><span class="line">  <span class="comment">// 取 13 位</span></span><br><span class="line">  <span class="keyword">return</span> ((data[offset + <span class="number">10</span>] &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">8</span>) | data[offset + <span class="number">11</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 PMT</span></span><br><span class="line"><span class="comment"> * 第1个字节是 table id</span></span><br><span class="line"><span class="comment"> * 第2个字节后四位 + 第3个字节 = section length</span></span><br><span class="line"><span class="comment"> * 第4，5字节表示 program number</span></span><br><span class="line"><span class="comment"> * 第6，7，8个字节表示固定值，version number，section number 等信息</span></span><br><span class="line"><span class="comment"> * 第9个字节的后5位 + 第10个字节 = PCR PID</span></span><br><span class="line"><span class="comment"> * 第11个字节后4位 + 第12个字节 = 产品描述字节的长度</span></span><br><span class="line"><span class="comment"> * 后面开始循环</span></span><br><span class="line"><span class="comment"> * =====</span></span><br><span class="line"><span class="comment"> * 第1个字节是 stream type，描述流类型</span></span><br><span class="line"><span class="comment"> * 第2字节后5位 + 第3字节 = 流 PID</span></span><br><span class="line"><span class="comment"> * 第4字节后4位 + 第5，6字节 = ES 信息长度</span></span><br><span class="line"><span class="comment"> * ES 信息</span></span><br><span class="line"><span class="comment"> * ====</span></span><br><span class="line"><span class="comment"> * CRC32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parsePMT</span>(<span class="params">data, offset, mpegSupported, isSampleAes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = &#123; audio: <span class="number">-1</span>, avc: <span class="number">-1</span>, id3: <span class="number">-1</span>, isAAC: <span class="literal">true</span> &#125;;</span><br><span class="line">  <span class="comment">// 0x0f -&gt; 0000 1111</span></span><br><span class="line">  <span class="comment">// section 长度取第二个字节后四位 + 第三个字节</span></span><br><span class="line">  <span class="keyword">const</span> sectionLength = ((data[offset + <span class="number">1</span>] &amp; <span class="number">0x0f</span>) &lt;&lt; <span class="number">8</span>) | data[offset + <span class="number">2</span>];</span><br><span class="line">  <span class="comment">// sectionLength 是从当前算到 CRC 32为止，所以需要 offset +3</span></span><br><span class="line">  <span class="comment">// -4 是为了不包含 CRC32</span></span><br><span class="line">  <span class="keyword">const</span> tableEnd = offset + <span class="number">3</span> + sectionLength - <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// to determine where the table is, we have to figure out how</span></span><br><span class="line">  <span class="comment">// long the program info descriptors are</span></span><br><span class="line">  <span class="comment">// 产品描述长度</span></span><br><span class="line">  <span class="keyword">const</span> programInfoLength =</span><br><span class="line">    ((data[offset + <span class="number">10</span>] &amp; <span class="number">0x0f</span>) &lt;&lt; <span class="number">8</span>) | data[offset + <span class="number">11</span>];</span><br><span class="line">  <span class="comment">// advance the offset to the first entry in the mapping table</span></span><br><span class="line">  offset += <span class="number">12</span> + programInfoLength;</span><br><span class="line">  <span class="comment">// 循环 N loop</span></span><br><span class="line">  <span class="keyword">while</span> (offset &lt; tableEnd) &#123;</span><br><span class="line">    <span class="keyword">const</span> pid = ((data[offset + <span class="number">1</span>] &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">8</span>) | data[offset + <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">switch</span> (data[offset]) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xcf</span>: <span class="comment">// SAMPLE-AES AAC</span></span><br><span class="line">        <span class="keyword">if</span> (!isSampleAes) &#123;</span><br><span class="line">          logger.log(</span><br><span class="line">            <span class="string">'ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream'</span></span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">/* falls through */</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x0f</span>: <span class="comment">// ISO/IEC 13818-7 ADTS AAC (MPEG-2 lower bit-rate audio)</span></span><br><span class="line">        <span class="keyword">if</span> (result.audio === <span class="number">-1</span>) &#123;</span><br><span class="line">          result.audio = pid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x15</span>:</span><br><span class="line">        <span class="keyword">if</span> (result.id3 === <span class="number">-1</span>) &#123;</span><br><span class="line">          result.id3 = pid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xdb</span>: <span class="comment">// SAMPLE-AES AVC</span></span><br><span class="line">        <span class="keyword">if</span> (!isSampleAes) &#123;</span><br><span class="line">          logger.log(</span><br><span class="line">            <span class="string">'H.264 with AES-128-CBC slice encryption found in unencrypted stream'</span></span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">/* falls through */</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x1b</span>: <span class="comment">// ITU-T Rec. H.264 and ISO/IEC 14496-10 (lower bit-rate video)</span></span><br><span class="line">        <span class="keyword">if</span> (result.avc === <span class="number">-1</span>) &#123;</span><br><span class="line">          result.avc = pid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// ISO/IEC 11172-3 (MPEG-1 audio)</span></span><br><span class="line">      <span class="comment">// or ISO/IEC 13818-3 (MPEG-2 halved sample rate audio)</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x03</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x04</span>:</span><br><span class="line">        <span class="keyword">if</span> (!mpegSupported) &#123;</span><br><span class="line">          logger.log(<span class="string">'MPEG audio found, not supported in this browser'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.audio === <span class="number">-1</span>) &#123;</span><br><span class="line">          result.audio = pid;</span><br><span class="line">          result.isAAC = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x24</span>:</span><br><span class="line">        logger.warn(<span class="string">'Unsupported HEVC stream type found'</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// logger.log('unknown stream type:' + data[offset]);</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// move to the next table entry</span></span><br><span class="line">    <span class="comment">// skip past the elementary stream descriptors, if present</span></span><br><span class="line">    offset += (((data[offset + <span class="number">3</span>] &amp; <span class="number">0x0f</span>) &lt;&lt; <span class="number">8</span>) | data[offset + <span class="number">4</span>]) + <span class="number">5</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-02-22</span><i class="fa fa-tag"></i><a class="tag" href="/tags/HLS/" title="HLS">HLS </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://idmrchan.com/2021/02/22/hlsjs-source-code-1/,Virgil Chan,HLS 源码分析（1）,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2021/02/19/hls-protocol-analysis/" title="HLS 协议详解">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>